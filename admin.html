<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Marly & Baskha RSVP</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, getDoc, query, orderBy, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBCtD1ZhcUND9bbOo1t7bqwiTB64asWVuY",
            authDomain: "mmrsvps-95e2a.firebaseapp.com",
            databaseURL: "https://mmrsvps-95e2a-default-rtdb.firebaseio.com",
            projectId: "mmrsvps-95e2a",
            storageBucket: "mmrsvps-95e2a.firebasestorage.app",
            messagingSenderId: "404940644347",
            appId: "1:404940644347:web:2bd0cc03c3832e8038b55e",
            measurementId: "G-2BBH6CDRY2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Make Firebase available globally
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseDoc = doc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseQuery = query;
        window.firebaseOrderBy = orderBy;
        window.firebaseServerTimestamp = serverTimestamp;
        window.firebaseWriteBatch = writeBatch;
        window.firebaseSignIn = signInWithEmailAndPassword;
        window.firebaseSignOut = signOut;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
    </script>

    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="login-section">
        <div class="login-card">
            <div class="login-header">
                <img src="Logo.jpeg" alt="Logo" class="login-logo">
                <h1>Admin Login</h1>
                <p>Marly & Baskha RSVP Management</p>
            </div>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary">Sign In</button>
                <div id="loginError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="dashboard-section" style="display: none;">
        <header class="dashboard-header">
            <div class="header-left">
                <img src="Logo.jpeg" alt="Logo" class="header-logo">
                <h1>RSVP Admin</h1>
            </div>
            <div class="header-right">
                <span id="userEmail"></span>
                <button id="logoutBtn" class="btn btn-secondary">Logout</button>
            </div>
        </header>

        <nav class="dashboard-nav">
            <button class="nav-tab active" data-tab="guests">Guest List</button>
            <button class="nav-tab" data-tab="settings">Form Settings</button>
            <button class="nav-tab" data-tab="rsvps">RSVPs</button>
            <button class="nav-tab" data-tab="analytics">Analytics</button>
            <button class="nav-tab" data-tab="email">Email</button>
        </nav>

        <main class="dashboard-content">
            <!-- Guest List Tab -->
            <div id="guestsTab" class="tab-content active">
                <div class="tab-header">
                    <h2>Guest List</h2>
                    <div class="tab-actions">
                        <button id="downloadTemplateBtn" class="btn btn-secondary">Download Template</button>
                        <label class="btn btn-secondary upload-btn">
                            Upload Excel/CSV
                            <input type="file" id="uploadFile" accept=".xlsx,.xls,.csv" hidden>
                        </label>
                        <button id="addGuestBtn" class="btn btn-primary">+ Add Guest</button>
                    </div>
                </div>

                <div class="search-bar">
                    <input type="text" id="guestSearch" placeholder="Search guests...">
                    <div class="guest-stats">
                        <span id="totalGuests">0</span> guests |
                        <span id="rsvpedGuests">0</span> RSVPed
                    </div>
                </div>

                <!-- Upload Preview Modal -->
                <div id="uploadPreview" class="modal" style="display: none;">
                    <div class="modal-content modal-large">
                        <div class="modal-header">
                            <h3>Import Preview</h3>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="import-options">
                                <label class="radio-option">
                                    <input type="radio" name="importMode" value="append" checked>
                                    <span>Add to existing guests</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="importMode" value="replace">
                                    <span>Replace all guests</span>
                                </label>
                            </div>
                            <div class="preview-table-container">
                                <table id="previewTable" class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Invitation Name</th>
                                            <th>Members</th>
                                            <th>Email</th>
                                            <th>Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <p id="previewCount"></p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary modal-cancel">Cancel</button>
                            <button id="confirmImportBtn" class="btn btn-primary">Import Guests</button>
                        </div>
                    </div>
                </div>

                <!-- Add/Edit Guest Modal -->
                <div id="guestModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="guestModalTitle">Add Guest</h3>
                            <button class="modal-close">&times;</button>
                        </div>
                        <form id="guestForm" class="modal-body">
                            <input type="hidden" id="guestId">
                            <div class="form-group">
                                <label for="guestName">Invitation Name *</label>
                                <input type="text" id="guestName" required placeholder="e.g. The Smith Family, or John Doe">
                            </div>
                            <div class="form-group">
                                <label for="guestEmail">Email</label>
                                <input type="email" id="guestEmail">
                            </div>
                            <div class="form-group">
                                <label>Members on this Invitation *</label>
                                <div id="familyMembersList" class="family-members-list"></div>
                                <div class="add-member-row">
                                    <input type="text" id="newMemberName" placeholder="Guest name">
                                    <button type="button" id="addMemberBtn" class="btn btn-secondary btn-small">+ Add</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="guestNotes">Notes</label>
                                <textarea id="guestNotes" rows="2"></textarea>
                            </div>
                        </form>
                        <div class="modal-footer">
                            <button class="btn btn-secondary modal-cancel">Cancel</button>
                            <button id="saveGuestBtn" class="btn btn-primary">Save</button>
                        </div>
                    </div>
                </div>

                <table id="guestsTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Invitation</th>
                            <th>Members</th>
                            <th>Email</th>
                            <th>RSVP Status</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="guestsTableBody">
                        <tr><td colspan="6" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Form Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="tab-header">
                    <h2>Form Settings</h2>
                    <button id="saveSettingsBtn" class="btn btn-primary">Save Settings</button>
                </div>

                <div class="settings-card">
                    <h3>RSVP Status</h3>
                    <p class="settings-description">Control whether guests can submit RSVPs</p>
                    <div class="rsvp-toggle-row">
                        <label class="toggle-switch">
                            <input type="checkbox" id="rsvpEnabledToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <span id="rsvpStatusLabel" class="rsvp-status-label">RSVPs are Open</span>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>Visible Form Fields</h3>
                    <p class="settings-description">Toggle which fields guests will see when RSVPing</p>

                    <div class="settings-grid">
                        <label class="toggle-option">
                            <input type="checkbox" id="field-phone" checked>
                            <span class="toggle-label">Phone Number</span>
                        </label>

                        <label class="toggle-option">
                            <input type="checkbox" id="field-relationship" checked>
                            <span class="toggle-label">Relationship to Couple</span>
                        </label>

                        <label class="toggle-option">
                            <input type="checkbox" id="field-mealPreference" checked>
                            <span class="toggle-label">Meal Preference</span>
                        </label>

                        <label class="toggle-option">
                            <input type="checkbox" id="field-dietary" checked>
                            <span class="toggle-label">Dietary Restrictions</span>
                        </label>

                        <label class="toggle-option">
                            <input type="checkbox" id="field-childrenCount" checked>
                            <span class="toggle-label">Children Count</span>
                        </label>

                        <label class="toggle-option">
                            <input type="checkbox" id="field-songRequest" checked>
                            <span class="toggle-label">Song Request</span>
                        </label>

                        <label class="toggle-option">
                            <input type="checkbox" id="field-transportNeeded">
                            <span class="toggle-label">Transportation Needed</span>
                        </label>

                        <label class="toggle-option">
                            <input type="checkbox" id="field-accommodationNeeded">
                            <span class="toggle-label">Accommodation Needed</span>
                        </label>

                        <label class="toggle-option">
                            <input type="checkbox" id="field-specialRequests" checked>
                            <span class="toggle-label">Special Requests</span>
                        </label>

                        <label class="toggle-option">
                            <input type="checkbox" id="field-message" checked>
                            <span class="toggle-label">Message to Couple</span>
                        </label>
                    </div>
                </div>

                <div id="settingsMessage" class="success-message" style="display: none;"></div>
            </div>

            <!-- RSVPs Tab -->
            <div id="rsvpsTab" class="tab-content">
                <div class="tab-header">
                    <h2>RSVP Responses</h2>
                    <button id="exportRsvpsBtn" class="btn btn-secondary">Export to CSV</button>
                </div>

                <div class="rsvp-stats">
                    <div class="stat-card">
                        <span class="stat-number" id="totalRsvps">0</span>
                        <span class="stat-label">Total RSVPs</span>
                    </div>
                    <div class="stat-card attending">
                        <span class="stat-number" id="attendingCount">0</span>
                        <span class="stat-label">Attending</span>
                    </div>
                    <div class="stat-card declined">
                        <span class="stat-number" id="declinedCount">0</span>
                        <span class="stat-label">Declined</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="totalGuestsCount">0</span>
                        <span class="stat-label">Total Attending</span>
                    </div>
                    <div class="stat-card declined">
                        <span class="stat-number" id="declinedMembersCount">0</span>
                        <span class="stat-label">Not Attending</span>
                    </div>
                </div>

                <table id="rsvpsTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Attending</th>
                            <th>Attending Members</th>
                            <th>Declined Members</th>
                            <th>Meal</th>
                            <th>Dietary</th>
                            <th>Message</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rsvpsTableBody">
                        <tr><td colspan="10" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Analytics Tab -->
            <div id="analyticsTab" class="tab-content">
                <div class="tab-header">
                    <h2>Analytics</h2>
                </div>

                <div class="analytics-stats">
                    <div class="stat-card">
                        <span class="stat-number" id="analyticsHouseholds">0</span>
                        <span class="stat-label">Total Invitations</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="analyticsTotalIndividuals">0</span>
                        <span class="stat-label">Total Individuals</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="analyticsResponseRate">0%</span>
                        <span class="stat-label">Response Rate</span>
                    </div>
                    <div class="stat-card attending">
                        <span class="stat-number" id="analyticsAttendanceRate">0%</span>
                        <span class="stat-label">Attendance Rate</span>
                    </div>
                    <div class="stat-card attending">
                        <span class="stat-number" id="analyticsHeadcount">0</span>
                        <span class="stat-label">Total Headcount</span>
                    </div>
                    <div class="stat-card declined">
                        <span class="stat-number" id="analyticsDeclined">0</span>
                        <span class="stat-label">Declined</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="analyticsPending">0</span>
                        <span class="stat-label">Pending</span>
                    </div>
                </div>

                <div class="analytics-charts">
                    <div class="chart-card">
                        <h3>RSVP Timeline</h3>
                        <canvas id="rsvpTimelineChart"></canvas>
                    </div>
                    <div class="chart-row">
                        <div class="chart-card chart-half">
                            <h3>Attendance Breakdown</h3>
                            <canvas id="attendanceChart"></canvas>
                        </div>
                        <div class="chart-card chart-half">
                            <h3>Meal Preferences</h3>
                            <canvas id="mealChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Family Size Distribution</h3>
                        <canvas id="familySizeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Email Tab -->
            <div id="emailTab" class="tab-content">
                <div class="tab-header">
                    <h2>Send Email</h2>
                </div>

                <div class="email-compose">
                    <div class="email-section">
                        <h3>Recipients</h3>
                        <div class="recipient-filters">
                            <button class="btn btn-secondary btn-small recipient-filter active" data-filter="all">All with Email</button>
                            <button class="btn btn-secondary btn-small recipient-filter" data-filter="attending">Attending</button>
                            <button class="btn btn-secondary btn-small recipient-filter" data-filter="declined">Declined</button>
                            <button class="btn btn-secondary btn-small recipient-filter" data-filter="pending">Pending</button>
                        </div>
                        <div class="recipient-actions">
                            <button id="selectAllRecipients" class="btn btn-secondary btn-small">Select All</button>
                            <button id="deselectAllRecipients" class="btn btn-secondary btn-small">Deselect All</button>
                            <span class="recipient-count"><span id="selectedCount">0</span> selected</span>
                        </div>
                        <div id="recipientList" class="recipient-list">
                            <p class="loading">Loading guests...</p>
                        </div>

                        <div class="custom-recipient-section">
                            <h4>Add Custom Recipients</h4>
                            <div class="custom-recipient-input">
                                <input type="text" id="customRecipientName" placeholder="Name">
                                <input type="email" id="customRecipientEmail" placeholder="Email">
                                <button type="button" id="addCustomRecipient" class="btn btn-secondary btn-small">+ Add</button>
                            </div>
                            <div id="customRecipientList" class="custom-recipient-list"></div>
                        </div>
                    </div>

                    <div class="email-section">
                        <h3>Compose</h3>
                        <div class="form-group">
                            <label for="emailFrom">From</label>
                            <input type="text" id="emailFrom" value="Marly & Michael <info@marlybaskha.ca>" readonly style="color: #666; cursor: default;">
                        </div>
                        <div class="form-group">
                            <label for="emailSubject">Subject *</label>
                            <input type="text" id="emailSubject" placeholder="Email subject line">
                        </div>
                        <div class="form-group">
                            <label for="emailBody">Message *</label>
                            <textarea id="emailBody" rows="12" placeholder="Write your email message here... HTML is supported."></textarea>
                        </div>
                    </div>

                    <button id="sendEmailBtn" class="btn btn-primary btn-large">Send Email</button>
                    <div id="emailStatus" class="email-status" style="display: none;"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="admin.js"></script>
</body>
</html>
